<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Hot-pluggable device drivers</title>
  <style>
    html {
      font-family: monospace;
      font-size: 12pt;
      line-height: 1.25;
      color: #1a1a1a;
      background-color: #F5F5F0;
    }
    body {
      margin: 0 auto;
      max-width: 52em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 12px;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      html {
        background-color: #F5F5F0;
      }
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: Blue;
    }
    a:visited {
      color: Blue;
    }
    img {
      max-width: 100%;
    }
    svg {
      height: auto;
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
      background-color: #E5E5E0;
      padding: .2em .4em;
      font-size: 85%;
      margin: 0;
      hyphens: manual;
    }
    pre {
      margin: 1em 0;
      background-color: #E5E5E0;
      padding: 1em;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      border: none;
      border-top: 1px solid #1a1a1a;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {  background-color: #f8f8f8; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ef2929; } /* Alert */
    code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #204a87; } /* Attribute */
    code span.bn { color: #0000cf; } /* BaseN */
    code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4e9a06; } /* Char */
    code span.cn { color: #8f5902; } /* Constant */
    code span.co { color: #8f5902; font-style: italic; } /* Comment */
    code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
    code span.dt { color: #204a87; } /* DataType */
    code span.dv { color: #0000cf; } /* DecVal */
    code span.er { color: #a40000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #0000cf; } /* Float */
    code span.fu { color: #204a87; font-weight: bold; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
    code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
    code span.ot { color: #8f5902; } /* Other */
    code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
    code span.sc { color: #ce5c00; font-weight: bold; } /* SpecialChar */
    code span.ss { color: #4e9a06; } /* SpecialString */
    code span.st { color: #4e9a06; } /* String */
    code span.va { color: #000000; } /* Variable */
    code span.vs { color: #4e9a06; } /* VerbatimString */
    code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <style>
    # span {
    #     opacity: 1.0;
    #     font-size: 12pt;
    # }

    img {
      # Border around images;
      # padding:            0px;
      border:             2px solid #333;
      # background-color:   #F0F;
      # color:              #000;
      # height:             12em;
      # float:              right;
      # clear:              right;
      # margin-left:        1em;
      # margin-bottom:      1em;
    }

    # code {
    #   Style of inline code;
    #   background-color:   #EEE;
    #   font-family:        "Courier New";
    #   font-size: 12pt;
    #   font-weight: bold;
    #   # border:             2px dashed #E33;
    #   padding:            1px;
    #   border-radius:      0.3em;
    # }

    # pre {
    #   Style of code listings;
    #   background-color:   #EEE;
    #   font-family:        "Courier New";
    #   font-weight: bold;
    #   border:             1px solid #333;
    #   padding:            3px;
    #   border-radius:      0.3em;
    # }

    figCaption {
      display:            block;
  }

  </style>
</head>
<body>
<header id="title-block-header">
<h1 class="title">Hot-pluggable device drivers</h1>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#introduction" id="toc-introduction"><span
class="toc-section-number">1</span> Introduction</a></li>
<li><a href="#hot-plugging" id="toc-hot-plugging"><span
class="toc-section-number">2</span> Hot-plugging</a>
<ul>
<li><a href="#device-tree-overlay" id="toc-device-tree-overlay"><span
class="toc-section-number">2.1</span> Device tree overlay</a></li>
<li><a href="#inserting-the-overlay"
id="toc-inserting-the-overlay"><span
class="toc-section-number">2.2</span> Inserting the overlay</a></li>
<li><a href="#registering-the-platform-driver"
id="toc-registering-the-platform-driver"><span
class="toc-section-number">2.3</span> Registering the platform
driver</a></li>
<li><a href="#inserting-and-removing-a-device"
id="toc-inserting-and-removing-a-device"><span
class="toc-section-number">2.4</span> Inserting and removing a
device</a></li>
<li><a href="#reading-and-writing-a-device"
id="toc-reading-and-writing-a-device"><span
class="toc-section-number">2.5</span> Reading and writing a
device</a></li>
</ul></li>
<li><a href="#installing-and-uninstalling-overlays-for-cold-plugging"
id="toc-installing-and-uninstalling-overlays-for-cold-plugging"><span
class="toc-section-number">3</span> Installing and uninstalling overlays
for cold-plugging</a></li>
<li><a href="#tests" id="toc-tests"><span
class="toc-section-number">4</span> Tests</a>
<ul>
<li><a href="#simple-example" id="toc-simple-example"><span
class="toc-section-number">4.1</span> Simple example</a></li>
<li><a href="#complex-example" id="toc-complex-example"><span
class="toc-section-number">4.2</span> Complex example</a></li>
<li><a
href="#inserting-overlays-beforeafter-inserting-the-kernel-module"
id="toc-inserting-overlays-beforeafter-inserting-the-kernel-module"><span
class="toc-section-number">4.3</span> Inserting overlays before/after
inserting the kernel module</a></li>
<li><a href="#removing-an-overlay-while-the-device-is-being-read"
id="toc-removing-an-overlay-while-the-device-is-being-read"><span
class="toc-section-number">4.4</span> Removing an overlay while the
device is being read</a></li>
</ul></li>
</ul>
</nav>
<h1 data-number="1" id="introduction"><span
class="header-section-number">1</span> Introduction</h1>
<p>We explore hot- and cold plugging of modules, and how to implement
these features in a device driver.</p>
<p>By <code>hot-plugging</code> we mean automated device discovery,
automated driver binding, and automated device creation in user
space.</p>
<p>We refer to the Linux documentation for <a
href="https://www.kernel.org/doc/html/next/driver-api/driver-model/platform.html">Platform
Devices and Drivers</a>.</p>
<h1 data-number="2" id="hot-plugging"><span
class="header-section-number">2</span> Hot-plugging</h1>
<p>We will start our exploration of the Linux device model by
implementing hot-plugging for a device driver.</p>
<h2 data-number="2.1" id="device-tree-overlay"><span
class="header-section-number">2.1</span> Device tree overlay</h2>
<div class="sourceCode" id="cb1"><pre
class="sourceCode default"><code class="sourceCode default"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>/dts-v1/;</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>/plugin/;</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>/ {</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  compatible = &quot;brcm,bcm2835&quot;, &quot;brcm,bcm2836&quot;, &quot;brcm,bcm2708&quot;, &quot;brcm,bcm2709&quot;;</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  fragment@0 {</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    /* Add device to base */</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    target-path = &quot;/&quot;;</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    __overlay__ {</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>      /* instance:type */</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>      sw2_led3_drv: sw2_led3_drv {</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>        /* Label to match in driver */</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>        compatible = &quot;ase, sw2_led3_drv&quot;;</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>        /* GPIO16 IN, GPIO 21 OUT. Here, 0=IN and 1=OUT. */</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>        gpios = &lt;&amp;gpio 16 0&gt;, &lt;&amp;gpio 21 1&gt;;</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>        /* Custom property. Default OUT value for the LED on GPIO21. */</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>        default_output_value = &lt;0x1&gt;;</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>        status = &quot;okay&quot;;</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>      };</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    };</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  };</span></code></pre></div>
<p>According to LDDD2 p177, each node has the form
<code>&lt;name&gt;[@&lt;address&gt;]</code>, where
<code>&lt;name&gt;</code> is a string and <code>&lt;address&gt;</code>
is an optional address, which is added if the node represents an
addressable device.</p>
<p>Our overlay contains a single fragment with <em>address</em>
<code>0</code>, which is in fact the index in the list of nodes (there
is only 1) in this overlay, and it could be safely removed. The fragment
<code>fragment@0</code> contain two nodes:</p>
<ul>
<li><code>target_path</code>: the absolute path of the node (in the
device tree source) that this fragment will modify, here
<code>"/"</code>, which corresponds to device tree root,
i.e. <code>/sys/firmware/devicetree/base/</code> (or
<code>/proc/device-tree</code>),</li>
<li><code>__overlay__</code>: the changes that will be applied to the
<code>"/"</code> node.</li>
</ul>
<p>The <code>sw2_led3_drv</code> node is also labelled
<code>sw2_led3_drv</code>. The character device is not addressable and
does not need to be indexed, so there is no need to write add the
optional <code>@0</code>. In fact, if we define the node as
<code>sw2_led3_drv: sw2_led3_drv@0</code>, we would get a warning when
compiling the overlay with the Device Tree Compiler (DTC):</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode default"><code class="sourceCode default"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>$ dtc -@ -I dts -O dtb -o sw2_led3_drv.dtbo sw2_led3_drv-overlay.dts</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>sw2_led3_drv-overlay.dts:12.36-24.9: Warning (unit_address_vs_reg): /fragment/__overlay__/sw2_led3_drv@0: node has a unit name, but no reg or ranges property</span></code></pre></div>
<!-- The `gpios` list property . -->
<p>Note that <code>&amp;gpio</code> is an alias of the
<code>gpio@7e200000</code> node, where <code>7e200000</code> is indeed
the address of the first GPIO register, c.f.
<code>BCM2835 ARM Peripherals</code> p. 90:</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cat /sys/firmware/devicetree/base/aliases/gpio</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="ex">/soc/gpio@7e200000</span></span></code></pre></div>
<p>See also the <code>gpio</code> node in
<code>arch/arm/boot/dts/bcm283x.dtsi</code>:</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>        <span class="ex">gpio:</span> gpio@7e200000 {</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>            <span class="ex">compatible</span> = <span class="st">&quot;brcm,bcm2835-gpio&quot;</span><span class="kw">;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>            <span class="ex">reg</span> = <span class="op">&lt;</span>0x7e200000 0xb4<span class="op">&gt;</span><span class="kw">;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>      <span class="ex">[...]</span></span></code></pre></div>
<p>In other terms, <code>&amp;gpio</code> will be replaced by the
phandle of the <code>gpio@7e200000</code> node.</p>
<h2 data-number="2.2" id="inserting-the-overlay"><span
class="header-section-number">2.2</span> Inserting the overlay</h2>
<p>The overlay can be inserted independently of our device driver.</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode default"><code class="sourceCode default"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>$ dtoverlay -d . sw2_led3_drv.dtbo</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>$ dtoverlay -l</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>Overlays (in load order):</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>0:  sw2_led3_drv</span></code></pre></div>
<p>As mentioned above, the new node <code>sw2_led3_drv</code> is
inserted into the root of the device tree source,
<code>/sys/firmware/devicetree/base/</code> (or
<code>/proc/device-tree</code>).</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode default"><code class="sourceCode default"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>$ ls -l /sys/firmware/devicetree/base/sw2_led3_drv/</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>-r--r--r--    1 root     root            18 Feb  7 10:54 compatible</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>-r--r--r--    1 root     root             4 Feb  7 10:54 default_output_value</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>-r--r--r--    1 root     root            24 Feb  7 10:54 gpios</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>-r--r--r--    1 root     root            13 Feb  7 10:54 name</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>-r--r--r--    1 root     root             5 Feb  7 10:54 status</span></code></pre></div>
<p>We can check that the value contained in each property file
corresponds to the value define in our overlay.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cat compatible </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="ex">ase,</span> sw2_led3_drv</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cat name</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="ex">sw2_led3_drv</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cat status</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="ex">okay</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> hexdump default_output_value</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="ex">0x0000000:</span> 00000001 </span></code></pre></div>
<p>The <code>gpios</code> list property contains the two GPIO
descriptions.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> hexdump  /sys/firmware/devicetree/base/sw2_led3_drv/gpios</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="ex">0x0000000:</span> 0000000a 00000010 00000000</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="ex">0x000000C:</span> 0000000a 00000015 00000001</span></code></pre></div>
<p>As <code>0x10=16</code> and <code>0x15=21</code>, we deduce that the
two lines above correspond to the two entries in our DTS,
<code>(&amp;gpio, 16, 0)</code> and <code>(&amp;gpio, 21, 1)</code>,
respectively.</p>
<h2 data-number="2.3" id="registering-the-platform-driver"><span
class="header-section-number">2.3</span> Registering the platform
driver</h2>
<p>Loading and unloading the overlay should trigger a call to the
<code>probe</code> and <code>remove</code> callbacks of our driver,
respectively. To achieve that, the driver needs first to be registered
using the <code>platform_driver_register</code> macro from the
<code>linux/platform_device.h</code> header.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>err <span class="op">=</span> platform_driver_register<span class="op">(&amp;</span>my_platform_driver<span class="op">);</span></span></code></pre></div>
<p>The parameter <code>my_platform_driver</code> is a
<code>platform_driver</code> structure that links together the device
tree overlay with the concrete <code>probe</code> and
<code>remove</code> callbacks.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="kw">struct</span> platform_driver my_platform_driver <span class="op">=</span> <span class="op">{</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>probe <span class="op">=</span> sw2_led3_drv_probe<span class="op">,</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>remove <span class="op">=</span> sw2_led3_drv_remove<span class="op">,</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>driver <span class="op">=</span> <span class="op">{</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>name <span class="op">=</span> <span class="st">&quot;sw2_led3_driver&quot;</span><span class="op">,</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>of_match_table <span class="op">=</span> sw2_led3_drv_match_table<span class="op">,</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>owner <span class="op">=</span> THIS_MODULE<span class="op">,</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">},</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>The <code>.of_match_table</code> field points to a
<code>of_device_id</code> structure.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="kw">struct</span> of_device_id sw2_led3_drv_match_table<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>compatible <span class="op">=</span> <span class="st">&quot;ase, sw2_led3_drv&quot;</span><span class="op">,</span> <span class="co">// Organisation: ase, Device: sw2_led3_drv</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">},</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">{},</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>The <code>.compatible</code> field is set to
<code>"ase, led3_drv"</code> to match the name chosen in the device tree
overlay.</p>
<h2 data-number="2.4" id="inserting-and-removing-a-device"><span
class="header-section-number">2.4</span> Inserting and removing a
device</h2>
<p>The <code>probe</code> callback has a <code>platform_device</code>
parameter, which can be used to retrieve the device node (filled in by
OF core), <code>pdev-&gt;dev.of_node</code>, associated with our
device.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> sw2_led3_drv_probe<span class="op">(</span><span class="kw">struct</span> platform_device <span class="op">*</span>pdev<span class="op">)</span> <span class="op">{</span> <span class="op">[...]</span> <span class="op">}</span></span></code></pre></div>
<p>The node created in the overlay contains a number of properties that
can be retrieved using the <code>properties</code> field of the device
node.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span><span class="kw">struct</span> property<span class="op">*</span> p <span class="op">=</span> pdev<span class="op">-&gt;</span>dev<span class="op">.</span>of_node<span class="op">-&gt;</span>properties<span class="op">;</span> p <span class="op">!=</span> NULL<span class="op">;</span> p <span class="op">=</span> p<span class="op">-&gt;</span>next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    pr_debug<span class="op">(</span><span class="st">&quot;</span><span class="sc">\t%s</span><span class="st"> (length </span><span class="sc">%i</span><span class="st">)</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> p<span class="op">-&gt;</span>name<span class="op">,</span> p<span class="op">-&gt;</span>length<span class="op">);</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>The code above prints the list of properties to the kernel log:</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode default"><code class="sourceCode default"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>[ 9254.926107] List of properties:</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>[ 9254.926115]   compatible (lengths 18)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>[ 9254.930371]   gpios (lengths 24)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>[ 9254.930384]   default_output_value (lengths 4)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>[ 9254.930393]   status (lengths 5)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>[ 9254.930402]   name (lengths 13)</span></code></pre></div>
<p>The <code>gpios</code> property is a <code>24</code> bytes long list,
which corresponds to the two 12-byte elements
<code>(&amp;gpio, 16, 0)</code> and <code>(&amp;gpio, 21, 1)</code>.
Then number of elements in that list is the number of GPIOs registered
in the node, and that number can be retrieved using the
<code>of_gpio_count()</code> function.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">((</span>gpios_len <span class="op">=</span> of_gpio_count<span class="op">(</span>pdev<span class="op">-&gt;</span>dev<span class="op">.</span>of_node<span class="op">))</span> <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    dev_err<span class="op">(&amp;</span>pdev<span class="op">-&gt;</span>dev<span class="op">,</span> <span class="st">&quot;of_gpio_count() failed</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> gpios_len<span class="op">;</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Knowing that there are two GPIOs in the <code>gpios</code> property,
we can retrieve, for each <code>index</code>, 0 and 1, the GPIO pin
number and its direction.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> gpio_num <span class="op">=</span> of_get_gpio<span class="op">(</span>pdev<span class="op">-&gt;</span>dev<span class="op">.</span>of_node<span class="op">,</span> index<span class="op">)</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> of_gpio_flags direction<span class="op">;</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>of_get_gpio_flags<span class="op">(</span>pdev<span class="op">-&gt;</span>dev<span class="op">.</span>of_node<span class="op">,</span> index<span class="op">,</span> <span class="op">&amp;</span>direction<span class="op">);</span></span></code></pre></div>
<p>The <code>default_ouput_value</code> property is the initial
brightness value of LED3.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>u32 default_output_value<span class="op">;</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>of_property_read_u32<span class="op">(</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    pdev<span class="op">-&gt;</span>dev<span class="op">.</span>of_node<span class="op">,</span> <span class="st">&quot;default_output_value&quot;</span><span class="op">,</span> <span class="op">&amp;</span>default_output_value<span class="op">);</span></span></code></pre></div>
<p>When all the information is collected, the two GPIOs are configured
accordingly in three separate for-loops, by first requesting the ports,
then setting their directions, and finally creating the corresponding
character devices.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span>index <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> index <span class="op">&lt;</span> gpios_len<span class="op">;</span> index<span class="op">++)</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">((</span>err <span class="op">=</span> gpio_request<span class="op">(</span>drv<span class="op">-&gt;</span>device<span class="op">[</span>index<span class="op">]-&gt;</span>gpio_nr<span class="op">,</span> drv<span class="op">-&gt;</span>device<span class="op">[</span>index<span class="op">]-&gt;</span>label<span class="op">))</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>        ERRGOTO<span class="op">(</span>gpio_request_failed<span class="op">,</span> <span class="st">&quot;gpio_request: FAIL</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span>index <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> index <span class="op">&lt;</span> gpios_len<span class="op">;</span> index<span class="op">++)</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> gpio_nr <span class="op">=</span> drv<span class="op">-&gt;</span>device<span class="op">[</span>index<span class="op">]-&gt;</span>gpio_nr<span class="op">;</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    err <span class="op">=</span> drv<span class="op">-&gt;</span>device<span class="op">[</span>index<span class="op">]-&gt;</span>direction <span class="op">==</span> <span class="dv">0</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>              <span class="op">?</span> gpio_direction_input<span class="op">(</span>gpio_nr<span class="op">)</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>              <span class="op">:</span> gpio_direction_output<span class="op">(</span>gpio_nr<span class="op">,</span> default_output_value<span class="op">);</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>err <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>        ERRGOTO<span class="op">(</span>gpio_direction_failed<span class="op">,</span> <span class="st">&quot;gpio_direction_input: FAIL</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span>index <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> index <span class="op">&lt;</span> gpios_len<span class="op">;</span> index<span class="op">++)</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    drv<span class="op">-&gt;</span>device<span class="op">[</span>index<span class="op">]-&gt;</span>dev <span class="op">=</span> device_create<span class="op">(</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>        drv<span class="op">-&gt;</span>class<span class="op">,</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>        NULL<span class="op">,</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>        MKDEV<span class="op">(</span>MAJOR<span class="op">(</span>drv<span class="op">-&gt;</span>dev_nr<span class="op">),</span> drv<span class="op">-&gt;</span>device<span class="op">[</span>index<span class="op">]-&gt;</span>minor<span class="op">),</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>        NULL<span class="op">,</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>        drv<span class="op">-&gt;</span>device<span class="op">[</span>index<span class="op">]-&gt;</span>label<span class="op">);</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">((</span>err <span class="op">=</span> IS_ERR<span class="op">(</span>drv<span class="op">-&gt;</span>device<span class="op">[</span>index<span class="op">]-&gt;</span>dev<span class="op">)))</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>        ERRGOTO<span class="op">(</span>device_create_failed<span class="op">,</span> <span class="st">&quot;device_create: FAIL</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span></code></pre></div>
<p>Error management is slightly more complex than usual since we cannot
afford to introduce a GOTO-label for each individual GPIO registration
(the number of which is in principle unknown at compilation time).
Instead, a GOTO-label is added for each of the three loops, and the
<code>index</code> loop variable is used to revert what was done until
the error occurred.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>device_create_failed<span class="op">:</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> index<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    pr_debug<span class="op">(</span><span class="st">&quot;unrolling: device_destroy at index </span><span class="sc">%i</span><span class="st">.</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> index<span class="op">);</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    device_destroy<span class="op">(</span>drv<span class="op">-&gt;</span>class<span class="op">,</span> MKDEV<span class="op">(</span>MAJOR<span class="op">(</span>drv<span class="op">-&gt;</span>dev_nr<span class="op">),</span> drv<span class="op">-&gt;</span>device<span class="op">[</span>i<span class="op">]-&gt;</span>minor<span class="op">));</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>gpio_direction_failed<span class="op">:</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  index <span class="op">=</span> gpios_len<span class="op">;</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>gpio_request_failed<span class="op">:</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> index<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> gpio_nr <span class="op">=</span> drv<span class="op">-&gt;</span>device<span class="op">[</span>i<span class="op">]-&gt;</span>gpio_nr<span class="op">;</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    pr_debug<span class="op">(</span><span class="st">&quot;unrolling:  gpio_free(</span><span class="sc">%i</span><span class="st">) at index </span><span class="sc">%i</span><span class="st">.</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> gpio_nr<span class="op">,</span> i<span class="op">);</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    gpio_free<span class="op">(</span>gpio_nr<span class="op">);</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> err<span class="op">;</span></span></code></pre></div>
<p>When the overlay or the kernel module is removed, the
<code>remove</code> callback is invoked.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> sw2_led3_drv_remove<span class="op">(</span><span class="kw">struct</span> platform_device <span class="op">*</span>dev<span class="op">)</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> drv<span class="op">-&gt;</span>ngpios<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>        device_destroy<span class="op">(</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>            drv<span class="op">-&gt;</span>class<span class="op">,</span> MKDEV<span class="op">(</span>MAJOR<span class="op">(</span>drv<span class="op">-&gt;</span>dev_nr<span class="op">),</span> drv<span class="op">-&gt;</span>device<span class="op">[</span>i<span class="op">]-&gt;</span>minor<span class="op">));</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> drv<span class="op">-&gt;</span>ngpios<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>        gpio_free<span class="op">(</span>drv<span class="op">-&gt;</span>device<span class="op">[</span>i<span class="op">]-&gt;</span>gpio_nr<span class="op">);</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 data-number="2.5" id="reading-and-writing-a-device"><span
class="header-section-number">2.5</span> Reading and writing a
device</h2>
<p>The <code>read</code> and <code>write</code> callback functions are
shared between SW2 and LED3. We can learn which of the two devices
triggered the <code>read</code> or <code>write</code> operation by
retrieving the device’s minor number.</p>
<p>The <code>iminor()</code> function defined in <code>linux/fs.h</code>
can be used to extract a minor number from the <code>filep</code>
parameter.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="dt">ssize_t</span> device_read<span class="op">(</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> file <span class="op">*</span>filep<span class="op">,</span> <span class="dt">char</span> __user <span class="op">*</span>ubuf<span class="op">,</span> <span class="dt">size_t</span> count<span class="op">,</span> loff_t <span class="op">*</span>offset<span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="op">[...]</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(!(</span>dev <span class="op">=</span> get_device_by_minor<span class="op">(</span>drv<span class="op">,</span> iminor<span class="op">(</span>filep<span class="op">-&gt;</span>f_inode<span class="op">))))</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">-</span>EINVAL<span class="op">;</span></span></code></pre></div>
<p>We have defined a helper function,
<code>get_device_by_minor()</code>, which, given a minor number, returns
a <code>gpio_device_info</code> structure describing the corresponding
device.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>gpio_device_info <span class="op">*</span>get_device_by_minor<span class="op">(</span>driver_info <span class="op">*</span>drv<span class="op">,</span> <span class="dt">int</span> minor<span class="op">)</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>minor <span class="op">&lt;</span> drv<span class="op">-&gt;</span>first_minor <span class="op">||</span> minor <span class="op">&gt;=</span> drv<span class="op">-&gt;</span>first_minor <span class="op">+</span> drv<span class="op">-&gt;</span>number_of_minors<span class="op">)</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">(</span>gpio_device_info <span class="op">*)</span>NULL<span class="op">;</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> drv<span class="op">-&gt;</span>device<span class="op">[</span>minor <span class="op">-</span> drv<span class="op">-&gt;</span>first_minor<span class="op">];</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>When the correct device is resolved, we can extract its GPIO number
and proceed like we did in previous device drivers, e.g., read the
actual GPIO value.</p>
<p>Similarly, in the <code>write</code> callback, we start by resolving
the correct device and then proceed as usual, e.g., convert the user
buffer to an integer and write the value to the GPIO port.</p>
<h1 data-number="3"
id="installing-and-uninstalling-overlays-for-cold-plugging"><span
class="header-section-number">3</span> Installing and uninstalling
overlays for cold-plugging</h1>
<p>We have written installation and un-installation scripts. The
installation script configures the system such that our module and
device overlay are loaded at boot time.</p>
<p>Checking compatibility of our device:</p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode default"><code class="sourceCode default"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>dtoverlay -d . combi_drv.dtbo </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>ls /sys/firmware/devicetree/base/combi_drv\@0/compatible</span></code></pre></div>
<p>The installation script configures the system such the kernel module
and the device tree overlay are loaded at boot time. This is done by 1)
Copying <code>sw2_led3_drv.ko</code> to
<code>/lib/modules/&lt;kernel_version&gt;/</code>. 2) Registering the
module with <code>depmod -a</code>. 3) Adding a configuration,
<code>sw2_led3_drv.conf</code>, to <code>/etc/modules-load.d/</code>.
The configuration should contain a single line with the name of our
driver, <code>sw2_led3_drv</code>. 4) Copying the device tree blob,
<code>sw2_led3_drv.dtbo</code>, to <code>/boot/overlays</code>. 5)
Adding an entry, <code>dtoverlay=sw2_led3_drv</code>, to
<code>/boot/config.txt</code>.</p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> sw2_led3_drv.ko /lib/modules/<span class="kw">`</span><span class="fu">uname</span> <span class="at">-r</span><span class="kw">`</span>/</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="ex">depmod</span> <span class="at">-a</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;sw2_led3_drv&quot;</span> <span class="op">&gt;</span> /etc/modules-load.d/sw2_led3_drv.conf</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> sw2_led3_drv.dtbo /boot/overlays/</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="ot">! </span><span class="fu">grep</span> <span class="at">-qi</span> <span class="st">&quot;sw2_led3_drv&quot;</span> /boot/config.txt </span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="cf">then</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;## Enable sw2_led3_drv&quot;</span> <span class="op">&gt;&gt;</span> /boot/config.txt</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;dtoverlay=sw2_led3_drv&quot;</span> <span class="op">&gt;&gt;</span> /boot/config.txt</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;sw2_led3_drv is already added to /boot/config.txt&quot;</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span></code></pre></div>
<p>The un-installation script reverts all the things:</p>
<div class="sourceCode" id="cb25"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span> <span class="at">-f</span> /lib/modules/<span class="kw">`</span><span class="fu">uname</span> <span class="at">-r</span><span class="kw">`</span>/sw2_led3_drv.ko</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span> <span class="at">-f</span> /etc/modules-load.d/sw2_led3_drv.conf</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span> <span class="at">-f</span> /boot/overlays/sw2_led3_drv.dtbo</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="fu">sed</span> <span class="at">-i</span> <span class="st">&#39;/sw2_led3_drv/d&#39;</span> /boot/config.txt</span></code></pre></div>
<h1 data-number="4" id="tests"><span
class="header-section-number">4</span> Tests</h1>
<p>We demonstrate how to insert and remove device tree overlays.</p>
<h2 data-number="4.1" id="simple-example"><span
class="header-section-number">4.1</span> Simple example</h2>
<p>In this example, a single overlay describes the GPIO ports
corresponding to SW2 and LED3. First, we make sure that the list of
loaded overlays is empty.</p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode default"><code class="sourceCode default"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>$ dtoverlay -l</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>No overlays loaded</span></code></pre></div>
<p>Next, we insert our kernel module with
<code>insmod led3_drv.ko</code>, and check with the kernel log that the
module has been correctly loaded.</p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode default"><code class="sourceCode default"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>$ insmod sw2_led3_drv.ko</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>$ dmesg</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>[...]</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>[ 7951.957827] ====== INIT SW2-LED3 driver =====</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>[ 7951.963652] platform_driver_register: OK</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>[ 7951.963668] ========== END INIT ==========</span></code></pre></div>
<p>Naturally, a sysFS class <code>sw2_led3_class</code> has been
created, but it is still empty since the <code>sw2_led3</code> character
device has not been created yet.</p>
<div class="sourceCode" id="cb28"><pre
class="sourceCode default"><code class="sourceCode default"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>$ ls /sys/class | grep sw2_led3</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>sw2_led3_class</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>$ ls -a /sys/class/sw2_led3_class/</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>.   ..</span></code></pre></div>
<p>There is still no SW2 nor LED3 device in <code>/dev</code>
either.</p>
<div class="sourceCode" id="cb29"><pre
class="sourceCode default"><code class="sourceCode default"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>$ ls -l /dev |  egrep &quot;(sw2|led3)&quot;</span></code></pre></div>
<p>Note that the major number is granted by
<code>alloc_chrdev_region()</code> in <code>init</code>, so
<code>sw2_led3</code> will appear in <code>/proc/devices</code> as soon
as the kernel module is <code>insmod</code>.</p>
<div class="sourceCode" id="cb30"><pre
class="sourceCode default"><code class="sourceCode default"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>$ cat /proc/devices | grep sw2_led3</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>239 sw2_led3_drv</span></code></pre></div>
<p>Next we load the <code>sw2_led3_drv.dtbo</code> device tree blob.</p>
<div class="sourceCode" id="cb31"><pre
class="sourceCode default"><code class="sourceCode default"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>$ dtoverlay -d . sw2_led3_drv.dtbo </span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>$ dtoverlay -l</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>Overlays (in load order):</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>0:  sw2_led3_drv</span></code></pre></div>
<p>We can check in the kernel log that the <code>probe</code> callback
has been invoked in our device driver.</p>
<div class="sourceCode" id="cb32"><pre
class="sourceCode default"><code class="sourceCode default"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>$ dmesg</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>[...]</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>[ 8384.779714] ====== PROBE SW2-LED3 driver =====</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>[ 8384.779735] inserting sw2_led3_drv...</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>[...]</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>[ 8384.787378] Device numbers were allocated: [major: 239, minors: 0 1].</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>[ 8384.787395] The sw2_led3_drv module has been inserted into the kernel.</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>[ 8384.787404] ========= END PROBE ==========</span></code></pre></div>
<p>The <code>probe</code> callback creates the <code>sw2</code> and
<code>led3</code> devices. sysFS devices have now been created in
<code>/sys/class/led3-class</code> as well as a device node in
<code>/dev</code>.</p>
<div class="sourceCode" id="cb33"><pre
class="sourceCode default"><code class="sourceCode default"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>$ ls -l /sys/class/sw2_led3_class/ | tr -s &#39; &#39;</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>lrwxrwxrwx 1 root root 0 Feb 7 13:13 led3 -&gt; ../../devices/virtual/sw2_led3_class/led3</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>lrwxrwxrwx 1 root root 0 Feb 7 13:13 sw2 -&gt; ../../devices/virtual/sw2_led3_class/sw2</span></code></pre></div>
<div class="sourceCode" id="cb34"><pre
class="sourceCode default"><code class="sourceCode default"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>$ ls -l /dev | egrep &quot;(sw2|led3)&quot; | tr -s &#39; &#39;</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>crw------- 1 root root 239, 1 Feb 7 13:10 led3</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>crw------- 1 root root 239, 0 Feb 7 13:10 sw2</span></code></pre></div>
<p>LED3 can now be turned on and off by echoing to
<code>/dev/led3</code>, and likewise, the state of SW2 can be read with
<code>cat /dev/sw2</code>.</p>
<p>Let us now remove the overlay.</p>
<div class="sourceCode" id="cb35"><pre
class="sourceCode default"><code class="sourceCode default"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>$ dtoverlay -r sw2_led3_drv </span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>$ dtoverlay -l             </span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>No overlays loaded</span></code></pre></div>
<p>Removing the overlay automatically invokes the <code>remove</code>
callback of our driver.</p>
<div class="sourceCode" id="cb36"><pre
class="sourceCode default"><code class="sourceCode default"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>$ dmesg</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>[...]</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>[ 8882.057469] ===== REMOVE SW2-LED3 driver =====</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>[ 8882.057490] removing sw2_led3_drv...</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>[ 8882.067545] device_destroy: OK</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>[ 8882.067593] gpio_free: OK</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>[ 8882.067602] ======== END REMOVE ==========</span></code></pre></div>
<p>All created in devices in <code>/sys/class</code> and
<code>/dev</code> have now been deleted by the <code>remove</code>
callback.</p>
<div class="sourceCode" id="cb37"><pre
class="sourceCode default"><code class="sourceCode default"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>$ ls -l /dev | egrep &quot;(sw2|led3)&quot;</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>$ ls -a /sys/class/sw2_led3_class/</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>.   ..</span></code></pre></div>
<p>Finally, we can remove our kernel module with <code>rmmod</code>.</p>
<div class="sourceCode" id="cb38"><pre
class="sourceCode default"><code class="sourceCode default"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>$ rmmod sw2_led3_drv.ko</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>$ dmesg</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>[...]</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>[ 9102.764502] ===== EXIT SW2-LED3 driver ======</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>[ 9102.769221] platform_driver_unregister: OK</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>[ 9102.769352] ========== END EXIT ==========</span></code></pre></div>
<p>The sysFS class has been removed, as well as the character device
registration in <code>/proc/devices</code>.</p>
<div class="sourceCode" id="cb39"><pre
class="sourceCode default"><code class="sourceCode default"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>$ls /sys/class | egrep sw2_led3</span></code></pre></div>
<h2 data-number="4.2" id="complex-example"><span
class="header-section-number">4.2</span> Complex example</h2>
<p>We show below a demonstration making use of five separate overlays,
for SW1, SW2, LED1, LED2, and LED3, respectively.</p>
<div class="sourceCode" id="cb40"><pre
class="sourceCode default"><code class="sourceCode default"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>$ ./test_swled_drv.sh </span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a># Fresh start...</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>dtoverlay -R</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>rmmod swled_drv</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>dmesg -C</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a># Insert module...</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>insmod swled_drv.ko</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>dmesg</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>[ 7072.130127] ====== INIT =====</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>[ 7072.134960] platform_driver_register: OK</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>[ 7072.134979] ========== END INIT ==========</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>dmesg -C</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a># A swled_class class has been created, but it is empty...</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>ls /sys/class | grep swled</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>swled_class</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>ls -a /sys/class/swled_class/</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>.   ..</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a># ... and still no SWs nor LEDs devices in /dev.</span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>ls -l /dev |  egrep &quot;(sw1|sw2|led1|led2|led3)&quot;</span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a># Add overlays, and the probe callbacks are invoked.</span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>dtoverlay -d . sw1_overlay.dtbo </span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>dtoverlay -d . sw2_overlay.dtbo </span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>dtoverlay -d . led1_overlay.dtbo </span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>dtoverlay -d . led2_overlay.dtbo </span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>dtoverlay -d . led3_overlay.dtbo </span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a>dmesg</span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a>[ 7072.386494] ========== PROBE =========</span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a>[ 7072.386514] inserting sw1...</span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a>[ 7072.386565] of_get_gpio: 12</span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a>[ 7072.386607] of_get_gpio_flags: 0</span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a>[ 7072.394218] IRQ number: 160</span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a>[ 7072.394286] Device number was allocated: [major: 239, minor: 7].</span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a>[ 7072.394296] ========= END PROBE ==========</span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a>[ 7072.536499] ========== PROBE =========</span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true" tabindex="-1"></a>[ 7072.536520] inserting sw2...</span>
<span id="cb40-41"><a href="#cb40-41" aria-hidden="true" tabindex="-1"></a>[ 7072.536585] of_get_gpio: 16</span>
<span id="cb40-42"><a href="#cb40-42" aria-hidden="true" tabindex="-1"></a>[ 7072.536629] of_get_gpio_flags: 0</span>
<span id="cb40-43"><a href="#cb40-43" aria-hidden="true" tabindex="-1"></a>[ 7072.544063] IRQ number: 161</span>
<span id="cb40-44"><a href="#cb40-44" aria-hidden="true" tabindex="-1"></a>[ 7072.544129] Device number was allocated: [major: 239, minor: 8].</span>
<span id="cb40-45"><a href="#cb40-45" aria-hidden="true" tabindex="-1"></a>[ 7072.544139] ========= END PROBE ==========</span>
<span id="cb40-46"><a href="#cb40-46" aria-hidden="true" tabindex="-1"></a>[ 7072.685493] ========== PROBE =========</span>
<span id="cb40-47"><a href="#cb40-47" aria-hidden="true" tabindex="-1"></a>[ 7072.685513] inserting led1...</span>
<span id="cb40-48"><a href="#cb40-48" aria-hidden="true" tabindex="-1"></a>[ 7072.685563] of_get_gpio: 26</span>
<span id="cb40-49"><a href="#cb40-49" aria-hidden="true" tabindex="-1"></a>[ 7072.685606] of_get_gpio_flags: 1</span>
<span id="cb40-50"><a href="#cb40-50" aria-hidden="true" tabindex="-1"></a>[ 7072.685645] default_output_value: 1</span>
<span id="cb40-51"><a href="#cb40-51" aria-hidden="true" tabindex="-1"></a>[ 7072.692314] Device number was allocated: [major: 239, minor: 9].</span>
<span id="cb40-52"><a href="#cb40-52" aria-hidden="true" tabindex="-1"></a>[ 7072.692332] ========= END PROBE ==========</span>
<span id="cb40-53"><a href="#cb40-53" aria-hidden="true" tabindex="-1"></a>[ 7072.836492] ========== PROBE =========</span>
<span id="cb40-54"><a href="#cb40-54" aria-hidden="true" tabindex="-1"></a>[ 7072.836513] inserting led2...</span>
<span id="cb40-55"><a href="#cb40-55" aria-hidden="true" tabindex="-1"></a>[ 7072.836564] of_get_gpio: 20</span>
<span id="cb40-56"><a href="#cb40-56" aria-hidden="true" tabindex="-1"></a>[ 7072.836606] of_get_gpio_flags: 1</span>
<span id="cb40-57"><a href="#cb40-57" aria-hidden="true" tabindex="-1"></a>[ 7072.836645] default_output_value: 1</span>
<span id="cb40-58"><a href="#cb40-58" aria-hidden="true" tabindex="-1"></a>[ 7072.843284] Device number was allocated: [major: 239, minor: 10].</span>
<span id="cb40-59"><a href="#cb40-59" aria-hidden="true" tabindex="-1"></a>[ 7072.843302] ========= END PROBE ==========</span>
<span id="cb40-60"><a href="#cb40-60" aria-hidden="true" tabindex="-1"></a>[ 7072.986499] ========== PROBE =========</span>
<span id="cb40-61"><a href="#cb40-61" aria-hidden="true" tabindex="-1"></a>[ 7072.986518] inserting led3...</span>
<span id="cb40-62"><a href="#cb40-62" aria-hidden="true" tabindex="-1"></a>[ 7072.986568] of_get_gpio: 21</span>
<span id="cb40-63"><a href="#cb40-63" aria-hidden="true" tabindex="-1"></a>[ 7072.986609] of_get_gpio_flags: 1</span>
<span id="cb40-64"><a href="#cb40-64" aria-hidden="true" tabindex="-1"></a>[ 7072.986648] default_output_value: 1</span>
<span id="cb40-65"><a href="#cb40-65" aria-hidden="true" tabindex="-1"></a>[ 7072.994296] Device number was allocated: [major: 239, minor: 11].</span>
<span id="cb40-66"><a href="#cb40-66" aria-hidden="true" tabindex="-1"></a>[ 7072.994314] ========= END PROBE ==========</span>
<span id="cb40-67"><a href="#cb40-67" aria-hidden="true" tabindex="-1"></a>dmesg -C</span>
<span id="cb40-68"><a href="#cb40-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-69"><a href="#cb40-69" aria-hidden="true" tabindex="-1"></a># GPIO devices have been created in the class folder...</span>
<span id="cb40-70"><a href="#cb40-70" aria-hidden="true" tabindex="-1"></a>ls -l /sys/class/swled_class/ | tr -s &#39; &#39;</span>
<span id="cb40-71"><a href="#cb40-71" aria-hidden="true" tabindex="-1"></a>lrwxrwxrwx 1 root root 0 Feb 7 12:48 led1 -&gt; ../../devices/virtual/swled_class/led1</span>
<span id="cb40-72"><a href="#cb40-72" aria-hidden="true" tabindex="-1"></a>lrwxrwxrwx 1 root root 0 Feb 7 12:48 led2 -&gt; ../../devices/virtual/swled_class/led2</span>
<span id="cb40-73"><a href="#cb40-73" aria-hidden="true" tabindex="-1"></a>lrwxrwxrwx 1 root root 0 Feb 7 12:48 led3 -&gt; ../../devices/virtual/swled_class/led3</span>
<span id="cb40-74"><a href="#cb40-74" aria-hidden="true" tabindex="-1"></a>lrwxrwxrwx 1 root root 0 Feb 7 12:48 sw1 -&gt; ../../devices/virtual/swled_class/sw1</span>
<span id="cb40-75"><a href="#cb40-75" aria-hidden="true" tabindex="-1"></a>lrwxrwxrwx 1 root root 0 Feb 7 12:48 sw2 -&gt; ../../devices/virtual/swled_class/sw2</span>
<span id="cb40-76"><a href="#cb40-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-77"><a href="#cb40-77" aria-hidden="true" tabindex="-1"></a># ... and in /dev.</span>
<span id="cb40-78"><a href="#cb40-78" aria-hidden="true" tabindex="-1"></a>ls -l /dev | egrep &quot;(sw1|sw2|led1|led2|led3)&quot; | tr -s &#39; &#39;</span>
<span id="cb40-79"><a href="#cb40-79" aria-hidden="true" tabindex="-1"></a>crw------- 1 root root 239, 9 Feb 7 12:48 led1</span>
<span id="cb40-80"><a href="#cb40-80" aria-hidden="true" tabindex="-1"></a>crw------- 1 root root 239, 10 Feb 7 12:48 led2</span>
<span id="cb40-81"><a href="#cb40-81" aria-hidden="true" tabindex="-1"></a>crw------- 1 root root 239, 11 Feb 7 12:48 led3</span>
<span id="cb40-82"><a href="#cb40-82" aria-hidden="true" tabindex="-1"></a>crw------- 1 root root 239, 7 Feb 7 12:48 sw1</span>
<span id="cb40-83"><a href="#cb40-83" aria-hidden="true" tabindex="-1"></a>crw------- 1 root root 239, 8 Feb 7 12:48 sw2</span>
<span id="cb40-84"><a href="#cb40-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-85"><a href="#cb40-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-86"><a href="#cb40-86" aria-hidden="true" tabindex="-1"></a># We remove the LED1 overlay in order to trigger `remove` operations...</span>
<span id="cb40-87"><a href="#cb40-87" aria-hidden="true" tabindex="-1"></a>dtoverlay -r led1_overlay</span>
<span id="cb40-88"><a href="#cb40-88" aria-hidden="true" tabindex="-1"></a>dmesg</span>
<span id="cb40-89"><a href="#cb40-89" aria-hidden="true" tabindex="-1"></a>[ 7073.330086] ========= REMOVE =========</span>
<span id="cb40-90"><a href="#cb40-90" aria-hidden="true" tabindex="-1"></a>[ 7073.330113] removing led3 [minor = 11]...</span>
<span id="cb40-91"><a href="#cb40-91" aria-hidden="true" tabindex="-1"></a>[ 7073.337278] device_destroy: OK</span>
<span id="cb40-92"><a href="#cb40-92" aria-hidden="true" tabindex="-1"></a>[ 7073.337314] gpio_free: OK</span>
<span id="cb40-93"><a href="#cb40-93" aria-hidden="true" tabindex="-1"></a>[ 7073.337325] ======== END REMOVE ==========</span>
<span id="cb40-94"><a href="#cb40-94" aria-hidden="true" tabindex="-1"></a>[ 7073.341424] ========= REMOVE =========</span>
<span id="cb40-95"><a href="#cb40-95" aria-hidden="true" tabindex="-1"></a>[ 7073.341450] removing led2 [minor = 10]...</span>
<span id="cb40-96"><a href="#cb40-96" aria-hidden="true" tabindex="-1"></a>[ 7073.343120] device_destroy: OK</span>
<span id="cb40-97"><a href="#cb40-97" aria-hidden="true" tabindex="-1"></a>[ 7073.343154] gpio_free: OK</span>
<span id="cb40-98"><a href="#cb40-98" aria-hidden="true" tabindex="-1"></a>[ 7073.343165] ======== END REMOVE ==========</span>
<span id="cb40-99"><a href="#cb40-99" aria-hidden="true" tabindex="-1"></a>[ 7073.347189] ========= REMOVE =========</span>
<span id="cb40-100"><a href="#cb40-100" aria-hidden="true" tabindex="-1"></a>[ 7073.347212] removing led1 [minor = 9]...</span>
<span id="cb40-101"><a href="#cb40-101" aria-hidden="true" tabindex="-1"></a>[ 7073.348561] device_destroy: OK</span>
<span id="cb40-102"><a href="#cb40-102" aria-hidden="true" tabindex="-1"></a>[ 7073.348599] gpio_free: OK</span>
<span id="cb40-103"><a href="#cb40-103" aria-hidden="true" tabindex="-1"></a>[ 7073.348609] ======== END REMOVE ==========</span>
<span id="cb40-104"><a href="#cb40-104" aria-hidden="true" tabindex="-1"></a>[ 7073.362189] ========== PROBE =========</span>
<span id="cb40-105"><a href="#cb40-105" aria-hidden="true" tabindex="-1"></a>[ 7073.362208] inserting led2...</span>
<span id="cb40-106"><a href="#cb40-106" aria-hidden="true" tabindex="-1"></a>[ 7073.362258] of_get_gpio: 20</span>
<span id="cb40-107"><a href="#cb40-107" aria-hidden="true" tabindex="-1"></a>[ 7073.362300] of_get_gpio_flags: 1</span>
<span id="cb40-108"><a href="#cb40-108" aria-hidden="true" tabindex="-1"></a>[ 7073.362338] default_output_value: 1</span>
<span id="cb40-109"><a href="#cb40-109" aria-hidden="true" tabindex="-1"></a>[ 7073.362714] Device number was allocated: [major: 239, minor: 10].</span>
<span id="cb40-110"><a href="#cb40-110" aria-hidden="true" tabindex="-1"></a>[ 7073.364924] ========= END PROBE ==========</span>
<span id="cb40-111"><a href="#cb40-111" aria-hidden="true" tabindex="-1"></a>[ 7073.371294] ========== PROBE =========</span>
<span id="cb40-112"><a href="#cb40-112" aria-hidden="true" tabindex="-1"></a>[ 7073.371313] inserting led3...</span>
<span id="cb40-113"><a href="#cb40-113" aria-hidden="true" tabindex="-1"></a>[ 7073.371362] of_get_gpio: 21</span>
<span id="cb40-114"><a href="#cb40-114" aria-hidden="true" tabindex="-1"></a>[ 7073.371404] of_get_gpio_flags: 1</span>
<span id="cb40-115"><a href="#cb40-115" aria-hidden="true" tabindex="-1"></a>[ 7073.371442] default_output_value: 1</span>
<span id="cb40-116"><a href="#cb40-116" aria-hidden="true" tabindex="-1"></a>[ 7073.379046] Device number was allocated: [major: 239, minor: 11].</span>
<span id="cb40-117"><a href="#cb40-117" aria-hidden="true" tabindex="-1"></a>[ 7073.379064] ========= END PROBE ==========</span>
<span id="cb40-118"><a href="#cb40-118" aria-hidden="true" tabindex="-1"></a>dmesg -C</span>
<span id="cb40-119"><a href="#cb40-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-120"><a href="#cb40-120" aria-hidden="true" tabindex="-1"></a># Now the LED1 device have been removed from /dev.</span>
<span id="cb40-121"><a href="#cb40-121" aria-hidden="true" tabindex="-1"></a>ls -l /dev | egrep &quot;(sw1|sw2|led1|led2|led3)&quot;</span>
<span id="cb40-122"><a href="#cb40-122" aria-hidden="true" tabindex="-1"></a>crw-------    1 root     root      239,  10 Feb  7 12:48 led2</span>
<span id="cb40-123"><a href="#cb40-123" aria-hidden="true" tabindex="-1"></a>crw-------    1 root     root      239,  11 Feb  7 12:48 led3</span>
<span id="cb40-124"><a href="#cb40-124" aria-hidden="true" tabindex="-1"></a>crw-------    1 root     root      239,   7 Feb  7 12:48 sw1</span>
<span id="cb40-125"><a href="#cb40-125" aria-hidden="true" tabindex="-1"></a>crw-------    1 root     root      239,   8 Feb  7 12:48 sw2</span>
<span id="cb40-126"><a href="#cb40-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-127"><a href="#cb40-127" aria-hidden="true" tabindex="-1"></a># We remove GPIO device overlays backwards so the `probe` operation of the</span>
<span id="cb40-128"><a href="#cb40-128" aria-hidden="true" tabindex="-1"></a># remaining devices is not invoked. We leave sw1 though.</span>
<span id="cb40-129"><a href="#cb40-129" aria-hidden="true" tabindex="-1"></a>dtoverlay -r led3_overlay</span>
<span id="cb40-130"><a href="#cb40-130" aria-hidden="true" tabindex="-1"></a>dtoverlay -r led2_overlay</span>
<span id="cb40-131"><a href="#cb40-131" aria-hidden="true" tabindex="-1"></a>dtoverlay -r sw2_overlay</span>
<span id="cb40-132"><a href="#cb40-132" aria-hidden="true" tabindex="-1"></a>dmesg</span>
<span id="cb40-133"><a href="#cb40-133" aria-hidden="true" tabindex="-1"></a>[ 7073.726973] ========= REMOVE =========</span>
<span id="cb40-134"><a href="#cb40-134" aria-hidden="true" tabindex="-1"></a>[ 7073.727001] removing led3 [minor = 11]...</span>
<span id="cb40-135"><a href="#cb40-135" aria-hidden="true" tabindex="-1"></a>[ 7073.734338] device_destroy: OK</span>
<span id="cb40-136"><a href="#cb40-136" aria-hidden="true" tabindex="-1"></a>[ 7073.734375] gpio_free: OK</span>
<span id="cb40-137"><a href="#cb40-137" aria-hidden="true" tabindex="-1"></a>[ 7073.734385] ======== END REMOVE ==========</span>
<span id="cb40-138"><a href="#cb40-138" aria-hidden="true" tabindex="-1"></a>[ 7073.855660] ========= REMOVE =========</span>
<span id="cb40-139"><a href="#cb40-139" aria-hidden="true" tabindex="-1"></a>[ 7073.855689] removing led2 [minor = 10]...</span>
<span id="cb40-140"><a href="#cb40-140" aria-hidden="true" tabindex="-1"></a>[ 7073.863025] device_destroy: OK</span>
<span id="cb40-141"><a href="#cb40-141" aria-hidden="true" tabindex="-1"></a>[ 7073.863060] gpio_free: OK</span>
<span id="cb40-142"><a href="#cb40-142" aria-hidden="true" tabindex="-1"></a>[ 7073.863070] ======== END REMOVE ==========</span>
<span id="cb40-143"><a href="#cb40-143" aria-hidden="true" tabindex="-1"></a>[ 7073.984186] ========= REMOVE =========</span>
<span id="cb40-144"><a href="#cb40-144" aria-hidden="true" tabindex="-1"></a>[ 7073.984213] removing sw2 [minor = 8]...</span>
<span id="cb40-145"><a href="#cb40-145" aria-hidden="true" tabindex="-1"></a>[ 7073.991438] device_destroy: OK</span>
<span id="cb40-146"><a href="#cb40-146" aria-hidden="true" tabindex="-1"></a>[ 7073.991476] gpio_free: OK</span>
<span id="cb40-147"><a href="#cb40-147" aria-hidden="true" tabindex="-1"></a>[ 7073.991487] ======== END REMOVE ==========</span>
<span id="cb40-148"><a href="#cb40-148" aria-hidden="true" tabindex="-1"></a>dmesg -C</span>
<span id="cb40-149"><a href="#cb40-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-150"><a href="#cb40-150" aria-hidden="true" tabindex="-1"></a># All GPIO devices but sw1 have been removed from /dev.</span>
<span id="cb40-151"><a href="#cb40-151" aria-hidden="true" tabindex="-1"></a>ls -l /dev | egrep &quot;(sw1|sw2|led1|led2|led3)&quot;</span>
<span id="cb40-152"><a href="#cb40-152" aria-hidden="true" tabindex="-1"></a>crw-------    1 root     root      239,   7 Feb  7 12:48 sw1</span>
<span id="cb40-153"><a href="#cb40-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-154"><a href="#cb40-154" aria-hidden="true" tabindex="-1"></a># We remove the module.</span>
<span id="cb40-155"><a href="#cb40-155" aria-hidden="true" tabindex="-1"></a>rmmod swled_drv</span>
<span id="cb40-156"><a href="#cb40-156" aria-hidden="true" tabindex="-1"></a>dmesg</span>
<span id="cb40-157"><a href="#cb40-157" aria-hidden="true" tabindex="-1"></a>[ 7074.191397] ===== EXIT ======</span>
<span id="cb40-158"><a href="#cb40-158" aria-hidden="true" tabindex="-1"></a>[ 7074.191475] ========= REMOVE =========</span>
<span id="cb40-159"><a href="#cb40-159" aria-hidden="true" tabindex="-1"></a>[ 7074.191495] removing sw1 [minor = 7]...</span>
<span id="cb40-160"><a href="#cb40-160" aria-hidden="true" tabindex="-1"></a>[ 7074.199487] device_destroy: OK</span>
<span id="cb40-161"><a href="#cb40-161" aria-hidden="true" tabindex="-1"></a>[ 7074.199525] gpio_free: OK</span>
<span id="cb40-162"><a href="#cb40-162" aria-hidden="true" tabindex="-1"></a>[ 7074.199536] ======== END REMOVE ==========</span>
<span id="cb40-163"><a href="#cb40-163" aria-hidden="true" tabindex="-1"></a>[ 7074.202069] platform_driver_unregister: OK</span>
<span id="cb40-164"><a href="#cb40-164" aria-hidden="true" tabindex="-1"></a>[ 7074.202148] ========== END EXIT ==========</span>
<span id="cb40-165"><a href="#cb40-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-166"><a href="#cb40-166" aria-hidden="true" tabindex="-1"></a># Now the swled_class class has been removed as well.</span>
<span id="cb40-167"><a href="#cb40-167" aria-hidden="true" tabindex="-1"></a>ls /sys/class | egrep swled</span>
<span id="cb40-168"><a href="#cb40-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-169"><a href="#cb40-169" aria-hidden="true" tabindex="-1"></a>$</span></code></pre></div>
<h2 data-number="4.3"
id="inserting-overlays-beforeafter-inserting-the-kernel-module"><span
class="header-section-number">4.3</span> Inserting overlays before/after
inserting the kernel module</h2>
<p>If the device tree blob is inserted <em>before</em> the kernel
module, then the <code>init</code> operation of the module will invoke
the <em>probe</em> operation.</p>
<div class="sourceCode" id="cb41"><pre
class="sourceCode default"><code class="sourceCode default"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>$ dtoverlay -d . sw1_overlay.dtbo </span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>$ insmod swled_drv.ko </span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>$ dmesg</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>[ 1059.933196] ====== INIT =====</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>[ 1059.939078] ========== PROBE =========</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>[ 1059.939097] inserting sw1...</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>[ 1059.939147] of_get_gpio: 12</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>[ 1059.939189] of_get_gpio_flags: 0</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>[ 1059.940661] IRQ number: 160</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>[ 1059.940728] Device number was allocated: [major: 239, minor: 7].</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>[ 1059.944066] ========= END PROBE ==========</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>[ 1059.944406] platform_driver_register: OK</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>[ 1059.944419] ========== END INIT ==========</span></code></pre></div>
<p>If the kernel module is already loaded, then insertion of the device
tree blob will trigger the <code>probe</code> operation of the
driver.</p>
<div class="sourceCode" id="cb42"><pre
class="sourceCode default"><code class="sourceCode default"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>$ insmod swled_drv.ko </span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>$ dtoverlay -d . sw1_overlay.dtbo </span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>$ dmesg</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>[ 1348.125125] ====== INIT =====</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>[ 1348.130974] platform_driver_register: OK</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>[ 1348.130992] ========== END INIT ==========</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>[ 1353.910518] ========== PROBE =========</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>[ 1353.910540] inserting sw1...</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>[ 1353.910590] of_get_gpio: 12</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>[ 1353.910633] of_get_gpio_flags: 0</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>[ 1353.919221] IRQ number: 160</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>[ 1353.919292] Device number was allocated: [major: 239, minor: 7].</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>[ 1353.919303] ========= END PROBE ==========</span></code></pre></div>
<p>The same behaviour is observed when an overlay is inserted
before/after the driver.</p>
<h2 data-number="4.4"
id="removing-an-overlay-while-the-device-is-being-read"><span
class="header-section-number">4.4</span> Removing an overlay while the
device is being read</h2>
<p>Let us assume that we’ve implemented a driver such that reading SW1
via <code>/dev/sw1</code> will block until the button is pushed or
released. What happens if the SW1 device overlay is removed while the
read operation is sleeping, waiting for the button to be pushed? Will
the driver handle the situation gracefully, or will the Linux kernel
crash altogether?</p>
<p>Let us insert the SW1 overlay and read <code>/dev/sw1</code> waiting
for input from SW1.</p>
<p><img src="images/1.png" id="fig:gpio19" style="width:100.0%" /></p>
<p>Then we remove the SW1 overlay and observe that the blocking
<code>read</code> has been interrupted.</p>
<p><img src="images/2.png" id="fig:gpio19" style="width:100.0%" /></p>
<p>We repeat the experiment by simultaneously reading from SW1 and
SW2.</p>
<p><img src="images/3.png" id="fig:gpio19" style="width:100.0%" /></p>
<p>Then, if we only remove SW2, then SW1 will still be inserted and only
the blocking <code>read</code> on SW2 is interrupted.</p>
<p><img src="images/4.png" id="fig:gpio19" style="width:100.0%" /></p>
<p>Note that the overlays are inserted in a <em>stack</em> fashion,
meaning that if we first insert SW1, and then SW2, we cannot remove SW1
without removing SW2 first.</p>
<p>Therefore, if we first remove the SW1 overlay, then <em>both</em> SW1
and SW2 overlays are removed, before the SW2 overlay is automatically
re-inserted. As a consequence, the <code>remove</code> operation will be
called twice, for SW1 and SW2, and the blocking <code>read</code>s of
both the <code>/dev/sw1</code> and <code>/dev/sw2</code> devices will be
interrupted.</p>
<p><img src="images/5.png" id="fig:gpio19" style="width:100.0%" /></p>
<p>The SW2 overlay is automatically re-inserted and the SW2 device
re-probed, such that we can immediately manually resume reading
<code>/dev/sw2</code>.</p>
<p><img src="images/7.png" id="fig:gpio19" style="width:100.0%" /></p>
</body>
</html>
