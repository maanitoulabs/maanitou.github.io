<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Getting started with cross-compilation</title>
  <style>
    html {
      font-family: monospace;
      font-size: 12pt;
      line-height: 1.25;
      color: #1a1a1a;
      background-color: #F5F5F0;
    }
    body {
      margin: 0 auto;
      max-width: 52em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 12px;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      html {
        background-color: #F5F5F0;
      }
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: Blue;
    }
    a:visited {
      color: Blue;
    }
    img {
      max-width: 100%;
    }
    svg {
      height: auto;
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
      background-color: #E5E5E0;
      padding: .2em .4em;
      font-size: 85%;
      margin: 0;
      hyphens: manual;
    }
    pre {
      margin: 1em 0;
      background-color: #E5E5E0;
      padding: 1em;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      border: none;
      border-top: 1px solid #1a1a1a;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {  background-color: #f8f8f8; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ef2929; } /* Alert */
    code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #204a87; } /* Attribute */
    code span.bn { color: #0000cf; } /* BaseN */
    code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4e9a06; } /* Char */
    code span.cn { color: #8f5902; } /* Constant */
    code span.co { color: #8f5902; font-style: italic; } /* Comment */
    code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
    code span.dt { color: #204a87; } /* DataType */
    code span.dv { color: #0000cf; } /* DecVal */
    code span.er { color: #a40000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #0000cf; } /* Float */
    code span.fu { color: #204a87; font-weight: bold; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
    code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
    code span.ot { color: #8f5902; } /* Other */
    code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
    code span.sc { color: #ce5c00; font-weight: bold; } /* SpecialChar */
    code span.ss { color: #4e9a06; } /* SpecialString */
    code span.st { color: #4e9a06; } /* String */
    code span.va { color: #000000; } /* Variable */
    code span.vs { color: #4e9a06; } /* VerbatimString */
    code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<header id="title-block-header">
<h1 class="title">Getting started with cross-compilation</h1>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#introduction" id="toc-introduction"><span
class="toc-section-number">1</span> Introduction</a></li>
<li><a href="#getting-all-the-files"
id="toc-getting-all-the-files"><span class="toc-section-number">2</span>
Getting all the files</a></li>
<li><a href="#installing-the-poky-sdk"
id="toc-installing-the-poky-sdk"><span
class="toc-section-number">3</span> Installing the Poky SDK</a></li>
<li><a href="#communicating-with-the-rpi."
id="toc-communicating-with-the-rpi."><span
class="toc-section-number">4</span> Communicating with the RPi.</a>
<ul>
<li><a href="#setting-up-the-host-as-a-gateway."
id="toc-setting-up-the-host-as-a-gateway."><span
class="toc-section-number">4.1</span> Setting up the host as a
gateway.</a></li>
<li><a href="#networking" id="toc-networking"><span
class="toc-section-number">4.2</span> Networking</a></li>
</ul></li>
<li><a href="#running-hello-world-on-the-rpi."
id="toc-running-hello-world-on-the-rpi."><span
class="toc-section-number">5</span> Running <code>Hello World</code> on
the RPi.</a></li>
<li><a href="#conclusion" id="toc-conclusion"><span
class="toc-section-number">6</span> Conclusion</a></li>
<li><a href="#addendum-a-bit-about-proc-and-syslog"
id="toc-addendum-a-bit-about-proc-and-syslog"><span
class="toc-section-number">7</span> Addendum: A bit about
<code>proc</code> and <code>syslog</code></a></li>
</ul>
</nav>
<h1 data-number="1" id="introduction"><span
class="header-section-number">1</span> Introduction</h1>
<p>In the following, we describe how to set up a working environment for
kernel module development targeting a RPi Zero Wifi running a custom
Linux distribution.</p>
<p>The original instructions are found behind the Redweb wall here: <a
href="https://redweb.ece.au.dk/devs/projects/raspberry-zero/wiki/RPiSupportInstallation">RPi
Support Installation</a>.</p>
<h1 data-number="2" id="getting-all-the-files"><span
class="header-section-number">2</span> Getting all the files</h1>
<p>We will be using a custom Linux distribution on the RPi Zero. The
image of the distribution <a
href="https://redweb.ece.au.dk/files/rpizerowifi-image-raspberrypi0-wifi.rpi-sdimg">rpizerowifi-image-raspberrypi0-wifi.rpi-sdimg</a>
is flashed onto an SD-card using <code>dd</code>. Replace
<code>&lt;SD-CARD&gt;</code> with the actual SD-card device.</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> dd if=rpizerowifi-image-raspberrypi0-wifi.rpi-sdimg <span class="dt">\</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>        of=/dev/<span class="op">&lt;</span>SD-CARD<span class="op">&gt;</span> bs=64k oflag=dsync status=progress</span></code></pre></div>
<p>The structure of the <code>sdimg</code> is as follows:</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode default"><code class="sourceCode default"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>$ fdisk -l rpizerowifi-image-raspberrypi0-wifi.rpi-sdimg </span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>Disk rpizerowifi-image-raspberrypi0-wifi.rpi-sdimg: 1 GiB, 1073741824 bytes, 2097152 sectors</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>Units: sectors of 1 * 512 = 512 bytes</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>Sector size (logical/physical): 512 bytes / 512 bytes</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>I/O size (minimum/optimal): 512 bytes / 512 bytes</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>Disklabel type: dos</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>Disk identifier: 0x03e22fb0</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>Device                                         Boot Start     End Sectors  Size Id Type</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>rpizerowifi-image-raspberrypi0-wifi.rpi-sdimg1 *     8192   90111   81920   40M  c W95 FAT32 (LBA)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>rpizerowifi-image-raspberrypi0-wifi.rpi-sdimg2      90112 2097151 2007040  980M 83 Linux</span></code></pre></div>
<p>We will need the following files from Redweb at
https://redweb.ece.au.dk/files/:</p>
<ul>
<li><code>rpi-x.yy.zz.tar.bz2</code></li>
<li><code>poky-glibc-x86_64-rpizerowifi-sdk-arm1176jzfshf-vfp-toolchain-aa.bb.cc.sh</code></li>
<li><code>bin.tar.gz</code></li>
</ul>
<p>Here, <code>x.yy.zz</code> and <code>aa.bb.cc</code> are version
numbers. The versions used as of January 2023 are:</p>
<ul>
<li><p><code>rpi-5.4.83.tar.bz2</code>: The kernel sources used by the
cross-compiler when compiling kernel modules.</p></li>
<li><p><code>poky-glibc-x86_64-rpizerowifi-sdk-arm1176jzfshf-vfp-raspberrypi0-wifi-toolchain-3.1.4.sh</code>:
There is no explanation of what that is. Apparently an installation
script for the Poky (Yocto project?) cross-compiler. Embedded in the
script is a huge binary probably containing the cross-compiler tool
chain. That will install a lot of stuff into
<code>/opt/poky/3.1.14/...</code>. (Why?)</p></li>
<li><p><code>bin.tar.gz</code>: The archive contains some scripts that
will be copied into <code>$HOME/bin</code>. Some scripts are tools used
for cross-compilation. As an example the content of
<code>arm-rpizw-g++</code> is:</p></li>
</ul>
<div class="sourceCode" id="cb3"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="bu">exec</span> arm-poky-linux-gnueabi-g++ <span class="dt">\</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">-march</span><span class="op">=</span>armv6 <span class="dt">\</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">-mfpu</span><span class="op">=</span>vfp <span class="dt">\</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">-mfloat-abi</span><span class="op">=</span>hard <span class="dt">\</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">-mtune</span><span class="op">=</span>arm1176jzf-s <span class="dt">\</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">-mfpu</span><span class="op">=</span>vfp <span class="dt">\</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">--sysroot</span><span class="op">=</span><span class="va">$SDKTARGETSYSROOT</span> <span class="va">$@</span></span></code></pre></div>
<p>The environment variable <code>SDKTARGETSYSROOT</code> is defined by
the <code>poky</code> script above.</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="va">SDKTARGETSYSROOT</span><span class="op">=</span>/opt/poky/3.1.4/sysroots/arm1176jzfshf-vfp-poky-linux-gnueabi</span></code></pre></div>
<p>It is the root directory (i.e. a <code>/</code> directory) containing
the Linux headers needed by the cross-compiler.</p>
<p>It could be interesting to know what the <code>poky</code> script
does precisely in addition to installing the cross-compiler and target
sources.</p>
<h1 data-number="3" id="installing-the-poky-sdk"><span
class="header-section-number">3</span> Installing the Poky SDK</h1>
<p>First we run the <code>poky</code> script, and then add the
destination folder <code>~/bin</code> to the <code>$PATH</code>
environment variable:</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">PATH</span><span class="op">=</span>~/bin:<span class="va">$PATH</span></span></code></pre></div>
<p>Next we run the <code>~/bin/addarmcompiler</code> script that sets
the <code>SDKTARGETROOT</code> environment variable (to
<code>/opt/poky/...</code>) and adds the Poky SDK path to the
<code>PATH</code> environment:</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">SDKTARGETSYSROOT</span><span class="op">=</span>/opt/poky/3.1.4/sysroots/arm1176jzfshf-vfp-poky-linux-gnueabi</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">PATH</span><span class="op">=</span>/opt/poky/3.1.4/sysroots/x86_64-pokysdk-linux/usr/bin/arm-poky-linux-gnueabi:<span class="va">$PATH</span></span></code></pre></div>
<p>The two <code>export</code> commands above should be added to
<code>~/.bashrc</code> or similar. Finally we extract the kernel sources
<code>rpi-5.4.83.tar.bz2</code> to <code>~/src/rpi.5.4.83/</code>. Those
sources are only needed when compiling kernel modules in which case the
name of the destination folder is passed on to the cross-compiler using
the <code>-C</code> flag.</p>
<h1 data-number="4" id="communicating-with-the-rpi."><span
class="header-section-number">4</span> Communicating with the RPi.</h1>
<p>Setting up a ssh connection with the RPi is a bit more complex and
may depend on the host Linux distribution. The setup described here
works for a host running a Linux Mint 21.1 installation.</p>
<h2 data-number="4.1" id="setting-up-the-host-as-a-gateway."><span
class="header-section-number">4.1</span> Setting up the host as a
gateway.</h2>
<p>First we enable IP forwarding on the host by setting
<code>net.ipv4.ip_forward=1</code> in <code>/etc/sysctl.conf</code>. The
new value for <code>net.ipv4.ip_forward</code> can be applied by
running:</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> sudo sysctl <span class="at">-p</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="ex">net.ipv4.ip_forward</span> = 1</span></code></pre></div>
<p>An alternative to editing <code>sysctl.conf</code>, is to run the
following command (the changes will not persist after a reboot
though):</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> sudo sysctl <span class="at">-w</span> net.ipv4.ip_forward=1</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="ex">net.ipv4.ip_forward</span> = 1</span></code></pre></div>
<p>Finally, we can check that ip-forwarding has been enabled:</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> sudo sysctl <span class="at">-a</span> <span class="kw">|</span> <span class="fu">grep</span> <span class="st">&quot;ipv4.ip_forward =&quot;</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="ex">net.ipv4.ip_forward</span> = 1</span></code></pre></div>
<h2 data-number="4.2" id="networking"><span
class="header-section-number">4.2</span> Networking</h2>
<p>The content of our <code>/etc/network/interfaces</code> is shown
below. Note that the first two lines are not mentioned in the Redweb
guide, however they seem to be absolutely essential to be able to
communicate with the RPi, otherwise trying to ping the RPi on 10.9.8.2
will block and timeout.</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cat /etc/network/interfaces</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="ex">auto</span> lo</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="ex">iface</span> lo inet loopback</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="ex">auto</span> usb0</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="ex">iface</span> usb0 inet static</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>   <span class="ex">address</span> 10.9.8.1</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>   <span class="ex">netmask</span> 255.255.255.0</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>   <span class="ex">up</span> iptables <span class="at">-A</span> FORWARD <span class="at">-i</span> usb0 <span class="at">-j</span> ACCEPT</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>   <span class="ex">up</span> iptables <span class="at">-A</span> FORWARD <span class="at">-o</span> usb0 <span class="at">-j</span> ACCEPT</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>   <span class="ex">up</span> iptables <span class="at">-t</span> nat <span class="at">-A</span> POSTROUTING <span class="at">-o</span> wlp1s0 <span class="at">-j</span> MASQUERADE</span></code></pre></div>
<ul>
<li><p>The <code>auto lo</code> line tells the system to bring up the
loopback interface when the system boots up.</p></li>
<li><p>The <code>iface lo inet loopback</code> line sets the IP address
for the interface. The loopback interface is used to enable
communication between processes running on the same computer.</p></li>
<li><p>For the second half of the interface configuration,
<code>usb0</code> is the RPi interface, and <code>wlp1s0</code> is the
host interface.</p></li>
<li><p>The <code>auto usb0</code> and
<code>iface usb0 inet static</code> lines set up a static IP address for
an interface.</p></li>
<li><p>The <code>address 10.9.8.1</code> line sets the IP address for
the interface (host side) and the <code>netmask 255.255.255.0</code>
line sets the network mask for the IP address.</p></li>
<li><p>The next two lines,
<code>up iptables -A FORWARD -i usb0 -j ACCEPT</code> and
<code>up iptables -A FORWARD -o usb0 -j ACCEPT</code>, allow packets to
be forwarded from and to the interface.</p></li>
<li><p>Finally, the
<code>up iptables -t nat -A POSTROUTING -o wlp1s0 -j MASQUERADE</code>
line allows NAT (Network Address Translation) to be used on the
interface. This allows the interface to be used to route traffic between
networks.</p></li>
</ul>
<p>We assume that the host side IP is <code>10.9.8.1</code>. The IP
address of the RPi is hard coded to <code>10.9.8.2</code> on the RPi. We
also assume that the RPi is connected to <code>usb0</code> (when running
<code>ifconfig</code>).</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ifconfig usb0</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="ex">usb0:</span> flags=4163<span class="op">&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class="op">&gt;</span>  mtu 1500</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>        <span class="ex">inet</span> 10.9.8.1  netmask 255.255.255.0  broadcast 10.9.8.255</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>        <span class="ex">inet6</span> fe80::3834:d4ff:fe99:5c9  prefixlen 64  scopeid 0x20<span class="op">&lt;</span>link<span class="op">&gt;</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>        <span class="ex">ether</span> 3a:34:d4:99:05:c9  txqueuelen 1000  <span class="er">(</span><span class="ex">Ethernet</span><span class="kw">)</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>        <span class="ex">RX</span> packets 0  bytes 0 <span class="er">(</span><span class="ex">0.0</span> B<span class="kw">)</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>        <span class="ex">RX</span> errors 0  dropped 0  overruns 0  frame 0</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>        <span class="ex">TX</span> packets 1  bytes 54 <span class="er">(</span><span class="ex">54.0</span> B<span class="kw">)</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>        <span class="ex">TX</span> errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span></code></pre></div>
<p>The <code>usb0</code> part must be configured elsewhere. In order to
force the virtual NIC (Network Interface Card) to be called
<code>usb0</code>, and not <code>sldknfou23i8uh1</code> (or any
arbitrarily generated name), we need to create a file
<code>70-persistent-net.rules</code> in <code>/etc/udev/rules.d/</code>
with the following content:</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode default"><code class="sourceCode default"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>SUBSYSTEM==&quot;net&quot;, ACTION==&quot;add&quot;, DRIVERS==&quot;cdc_ether&quot;, NAME=&quot;usb0&quot; </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>SUBSYSTEM==&quot;net&quot;, ACTION==&quot;add&quot;, DRIVERS==&quot;cdc_eem&quot;, NAME=&quot;usb0&quot; </span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>SUBSYSTEM==&quot;net&quot;, ACTION==&quot;add&quot;, DRIVERS==&quot;cdc_subset&quot;, NAME=&quot;usb0&quot; </span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>SUBSYSTEM==&quot;net&quot;, ACTION==&quot;add&quot;, DRIVERS==&quot;rndis_host&quot;, NAME=&quot;usb0&quot;</span></code></pre></div>
<p>We experienced that if the above configuration is omitted, then the
NIC will be renamed from <code>usb0</code> to something else when the
RPi is disconnected and then connected again.</p>
<p>When the RPi is connected to the host computer the following messages
are added to <code>dmesg</code>:</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode default"><code class="sourceCode default"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>[.] usb 1-1: Product: RNDIS/Ethernet Gadget</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>[.] usb 1-1: Manufacturer: Linux 5.4.83 with 20980000.usb</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>[.] cdc_subset: probe of 1-1:1.0 failed with error -22</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>[.] cdc_subset 1-1:1.1 usb0: register &#39;cdc_subset&#39; at usb-0000:00:14.0-1, Linux </span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>Device, 3a:34:d4:99:05:c9</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>[.] cdc_ether: probe of 1-1:1.0 failed with error -16</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>[.] usbcore: registered new interface driver cdc_subset</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>[.] usbcore: registered new interface driver cdc_ether</span></code></pre></div>
<p>When we are done setting up the network, it should be possible to
ping the RPi:</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ping 10.9.8.2</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="ex">PING</span> 10.9.8.2 <span class="er">(</span><span class="ex">10.9.8.2</span><span class="kw">)</span> <span class="ex">56</span><span class="er">(</span><span class="ex">84</span><span class="kw">)</span> <span class="ex">bytes</span> of data.</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="ex">64</span> bytes from 10.9.8.2: icmp_seq=1 ttl=64 time=1.96 ms</span></code></pre></div>
<p>We should now be able to open a chat session between the RPi and the
host. First connect to the RPi over ssh, run
<code>nc -l -p 1234</code>:</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ssh root@10.9.8.2</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="ex">root@raspberrypi0-wifi:~#</span> nc <span class="at">-l</span> <span class="at">-p</span> 1234</span></code></pre></div>
<p>Then, on the host,</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> nc 10.9.8.2 1234</span></code></pre></div>
<p>We now have a chat session open between the RPi and the host.</p>
<h1 data-number="5" id="running-hello-world-on-the-rpi."><span
class="header-section-number">5</span> Running <code>Hello World</code>
on the RPi.</h1>
<p>Let us write a Hello World program in <code>hello.c</code>:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">&quot;Hello world on the RPi!</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  exit<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><code>hello.c</code> can be cross-compiled targeting the RPi as
follows:</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode default"><code class="sourceCode default"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>$ ~/bin/arm-rpizw-gcc hello.c -o hello</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>$ file hello </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>hello: ELF 32-bit LSB pie executable, ARM, EABI5 version 1 (SYSV), dynamically </span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>linked, interpreter /lib/ld-linux-armhf.so.3, ...</span></code></pre></div>
<p>SCP the binary to the target:</p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode default"><code class="sourceCode default"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>$ scp hello root@10.9.8.2:hello</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>hello         100%   11KB   1.9MB/s   00:00 </span></code></pre></div>
<p>Then run the binary on the target:</p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode default"><code class="sourceCode default"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>$ ssh root@10.9.8.2</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>root@raspberrypi0-wifi:~# ./hello      </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>Hello world on the RPi!</span></code></pre></div>
<h1 data-number="6" id="conclusion"><span
class="header-section-number">6</span> Conclusion</h1>
<p>We have set up a development environment on our Linux Mint
distribution, which will enable us to cross-compile C and C++ programs
targeting a Raspberry Pi Zero W.</p>
<h1 data-number="7" id="addendum-a-bit-about-proc-and-syslog"><span
class="header-section-number">7</span> Addendum: A bit about
<code>proc</code> and <code>syslog</code></h1>
<p><code>/proc</code> is a pseudo file system, c.f.
<code>man proc</code>. From the documentation “<em>the <em>proc</em>
filesystem is a pseudo-filesystem which provides an interface to kernel
data structures</em>”. It is usually mounted at <code>/proc</code>, but
it can also be mounted to an arbitrary directory using a command such as
<code>mount -t proc proc /arbitrary_directory</code>. The manual page
for <code>proc</code> provides a description of the files and
directories found in <code>/proc</code>.</p>
<p>The <code>syslogging.c</code> program sends a message to the system
logger.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;syslog.h&gt;</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">char</span> <span class="op">*</span>IDENT <span class="op">=</span> <span class="st">&quot;pocahontas&quot;</span><span class="op">;</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> </span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> option <span class="op">=</span> LOG_CONS<span class="op">;</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> facility <span class="op">=</span> LOG_USER<span class="op">;</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> level <span class="op">=</span> LOG_INFO<span class="op">;</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> priority <span class="op">=</span> facility <span class="op">|</span> level<span class="op">;</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    openlog<span class="op">(</span>IDENT<span class="op">,</span> option<span class="op">,</span> facility<span class="op">);</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    syslog<span class="op">(</span>priority<span class="op">,</span> <span class="st">&quot;</span><span class="sc">%s</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;Wingapo&quot;</span><span class="op">);</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    closelog<span class="op">();</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>On the Linux Mint distribution the message is logged in
<code>/var/log/syslog</code>, c.f. <code>man 3 syslog</code> for more
information. On the RPi the message is logged in
<code>/var/log/messages</code>.</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> gcc <span class="at">-o</span> syslogging syslogging.c</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ./syslogging </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> tail <span class="at">-n</span> 1 /var/log/syslog</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="ex">May</span> 21 15:15:21 mint pocahontas: Wingapo</span></code></pre></div>
</body>
</html>
